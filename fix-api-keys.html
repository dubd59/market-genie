<!DOCTYPE html>
<html>
<head>
    <title>API Key Diagnostic & Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b6d4d9; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ API Key Diagnostic & Fix Tool</h1>
        <p>This tool will find your Prospeo API key and ensure it's in the correct tenant.</p>
        
        <button onclick="findApiKeys()">ğŸ” Find All API Keys</button>
        <button onclick="getCurrentTenant()">ğŸ‘¤ Check Current Tenant</button>
        <button onclick="copyApiKey()">ğŸ“‹ Copy API Key to Current Tenant</button>
        
        <div style="margin: 20px 0;">
            <h3>Manual API Key Entry</h3>
            <input type="text" id="apiKeyInput" placeholder="Enter your Prospeo API key" />
            <button onclick="saveApiKey()">ğŸ’¾ Save API Key</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBjh7XAYK6bGhHRsQmVwWrjxgOo4tD0c8M",
            authDomain: "superdupergene.firebaseapp.com",
            projectId: "superdupergene",
            storageBucket: "superdupergene.appspot.com",
            messagingSenderId: "1026936915894",
            appId: "1:1026936915894:web:bf7e62b13e57b8bedb26d9",
            measurementId: "G-NPPWMJ1E3T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let foundApiKeys = {};
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('results').innerHTML = `<div class="info">âœ… Logged in as: ${user.email}</div>`;
            }
        });

        window.findApiKeys = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">ğŸ” Searching for API keys across all tenants...</div>';
            
            try {
                // Get all tenants
                const tenantsRef = collection(db, 'MarketGenie_tenants');
                const tenantsSnap = await getDocs(tenantsRef);
                
                let output = '<h3>ğŸ” API Key Search Results</h3>';
                foundApiKeys = {};
                
                for (const tenantDoc of tenantsSnap.docs) {
                    const tenantId = tenantDoc.id;
                    const tenantData = tenantDoc.data();
                    
                    try {
                        // Check for Prospeo API key in this tenant
                        const prospeoRef = doc(db, 'MarketGenie_tenants', tenantId, 'integrations', 'prospeo-io');
                        const prospeoSnap = await getDoc(prospeoRef);
                        
                        if (prospeoSnap.exists()) {
                            const data = prospeoSnap.data();
                            foundApiKeys[tenantId] = data;
                            output += `<div class="success">âœ… Found Prospeo API key in tenant: ${tenantId}</div>`;
                            output += `<div class="info">ğŸ“§ Tenant owner: ${tenantData.ownerEmail || 'Unknown'}</div>`;
                            output += `<div class="info">ğŸ¯ Tenant name: ${tenantData.name || 'Unknown'}</div>`;
                            if (data.apiKey) {
                                output += `<div class="info">ğŸ”‘ API Key: ${data.apiKey.substring(0, 10)}...${data.apiKey.substring(data.apiKey.length - 4)}</div>`;
                            }
                            output += '<br>';
                        }
                    } catch (error) {
                        console.log(`No API key in tenant ${tenantId}`);
                    }
                }
                
                if (Object.keys(foundApiKeys).length === 0) {
                    output += '<div class="warning">âš ï¸ No Prospeo API keys found in any tenant</div>';
                    output += '<div class="info">You\'ll need to re-enter your API key manually</div>';
                }
                
                resultsDiv.innerHTML = output;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Error searching for API keys: ${error.message}</div>`;
            }
        };

        window.getCurrentTenant = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">ğŸ‘¤ Checking current tenant...</div>';
            
            try {
                // Check if user UID is a tenant
                const userTenantRef = doc(db, 'MarketGenie_tenants', currentUser.uid);
                const userTenantSnap = await getDoc(userTenantRef);
                
                let output = '<h3>ğŸ‘¤ Current Tenant Status</h3>';
                output += `<div class="info">ğŸ†” Your User ID: ${currentUser.uid}</div>`;
                output += `<div class="info">ğŸ“§ Your Email: ${currentUser.email}</div>`;
                
                if (userTenantSnap.exists()) {
                    const tenantData = userTenantSnap.data();
                    output += `<div class="success">âœ… You are tenant: ${currentUser.uid}</div>`;
                    output += `<div class="info">ğŸ“‹ Tenant Name: ${tenantData.name || 'Unknown'}</div>`;
                    output += `<div class="info">ğŸ¯ Plan: ${tenantData.plan || 'Unknown'}</div>`;
                    
                    // Check if this tenant has Prospeo API key
                    const prospeoRef = doc(db, 'MarketGenie_tenants', currentUser.uid, 'integrations', 'prospeo-io');
                    const prospeoSnap = await getDoc(prospeoRef);
                    
                    if (prospeoSnap.exists()) {
                        output += '<div class="success">âœ… Prospeo API key found in your tenant</div>';
                    } else {
                        output += '<div class="warning">âš ï¸ No Prospeo API key in your tenant</div>';
                        output += '<div class="info">This is why the bulk scraper is failing</div>';
                    }
                } else {
                    output += `<div class="error">âŒ Your user ID is not a tenant</div>`;
                    
                    // Search for tenant by email
                    const tenantsRef = collection(db, 'MarketGenie_tenants');
                    const tenantsSnap = await getDocs(tenantsRef);
                    
                    tenantsSnap.forEach((doc) => {
                        const data = doc.data();
                        if (data.ownerEmail === currentUser.email) {
                            output += `<div class="success">âœ… Found your tenant by email: ${doc.id}</div>`;
                        }
                    });
                }
                
                resultsDiv.innerHTML = output;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Error checking tenant: ${error.message}</div>`;
            }
        };

        window.copyApiKey = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            if (Object.keys(foundApiKeys).length === 0) {
                alert('Please run "Find All API Keys" first');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            
            try {
                // Find the first API key and copy it to current user's tenant
                const sourceApiKey = Object.values(foundApiKeys)[0];
                
                if (!sourceApiKey || !sourceApiKey.apiKey) {
                    resultsDiv.innerHTML = '<div class="error">âŒ No valid API key found to copy</div>';
                    return;
                }
                
                resultsDiv.innerHTML = '<div class="info">ğŸ“‹ Copying API key to your tenant...</div>';
                
                // Save to current user's tenant
                const targetRef = doc(db, 'MarketGenie_tenants', currentUser.uid, 'integrations', 'prospeo-io');
                await setDoc(targetRef, {
                    apiKey: sourceApiKey.apiKey,
                    enabled: true,
                    copiedAt: new Date().toISOString(),
                    copiedFrom: Object.keys(foundApiKeys)[0]
                });
                
                resultsDiv.innerHTML = '<div class="success">âœ… API key copied successfully! Try the bulk scraper again.</div>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Error copying API key: ${error.message}</div>`;
            }
        };

        window.saveApiKey = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">ğŸ’¾ Saving API key...</div>';
            
            try {
                const targetRef = doc(db, 'MarketGenie_tenants', currentUser.uid, 'integrations', 'prospeo-io');
                await setDoc(targetRef, {
                    apiKey: apiKey,
                    enabled: true,
                    savedAt: new Date().toISOString(),
                    method: 'manual'
                });
                
                resultsDiv.innerHTML = '<div class="success">âœ… API key saved successfully! Try the bulk scraper again.</div>';
                document.getElementById('apiKeyInput').value = '';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ Error saving API key: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>