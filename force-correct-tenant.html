<!DOCTYPE html>
<html>
<head>
    <title>Force Correct Tenant & API Key</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b6d4d9; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        .highlight { background: #fffbf0; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Force Correct Tenant & Fix API Key</h1>
        
        <div class="highlight">
            <h3>üéØ Target: Make app use your founder tenant U9vez3sI36Ti5JqoWi5gJUMq2nX2</h3>
            <p>This will force your app to use the correct tenant and add the API key there.</p>
        </div>
        
        <div style="margin: 20px 0;">
            <input type="text" id="apiKeyInput" placeholder="Enter your Prospeo API key" style="width: 400px;" />
            <br>
            <button onclick="fixEverything()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">
                üöÄ Fix Tenant & Add API Key
            </button>
        </div>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBjh7XAYK6bGhHRsQmVwWrjxgOo4tD0c8M",
            authDomain: "superdupergene.firebaseapp.com",
            projectId: "superdupergene",
            storageBucket: "superdupergene.appspot.com",
            messagingSenderId: "1026936915894",
            appId: "1:1026936915894:web:bf7e62b13e57b8bedb26d9",
            measurementId: "G-NPPWMJ1E3T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        const FOUNDER_TENANT = 'U9vez3sI36Ti5JqoWi5gJUMq2nX2';
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('results').innerHTML = `
                    <div class="info">‚úÖ Logged in as: ${user.email}</div>
                    <div class="info">üÜî Your User ID: ${user.uid}</div>
                    <div class="info">üéØ Target Tenant: ${FOUNDER_TENANT}</div>
                `;
            }
        });

        window.fixEverything = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('Please enter your Prospeo API key');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">üîß Fixing tenant and API key...</div>';
            
            try {
                let output = '<h3>üîß Fix Operation Results</h3>';
                
                // Step 1: Verify founder tenant exists
                output += '<h4>Step 1: Verify Founder Tenant</h4>';
                const founderTenantRef = doc(db, 'MarketGenie_tenants', FOUNDER_TENANT);
                const founderTenantSnap = await getDoc(founderTenantRef);
                
                if (!founderTenantSnap.exists()) {
                    output += '<div class="error">‚ùå Founder tenant does not exist!</div>';
                    resultsDiv.innerHTML = output;
                    return;
                }
                
                const founderData = founderTenantSnap.data();
                output += `<div class="success">‚úÖ Founder tenant exists: ${founderData.name}</div>`;
                output += `<div class="info">üìß Owner: ${founderData.ownerEmail}</div>`;
                
                // Step 2: Add API key to founder tenant
                output += '<h4>Step 2: Add API Key to Founder Tenant</h4>';
                const apiKeyRef = doc(db, 'MarketGenie_tenants', FOUNDER_TENANT, 'integrations', 'prospeo-io');
                await setDoc(apiKeyRef, {
                    apiKey: apiKey,
                    enabled: true,
                    addedAt: new Date().toISOString(),
                    method: 'force-fix-tool'
                });
                
                output += '<div class="success">‚úÖ API key added to founder tenant</div>';
                
                // Step 3: Force localStorage to use correct tenant
                output += '<h4>Step 3: Force Browser to Use Correct Tenant</h4>';
                const correctTenantData = {
                    id: FOUNDER_TENANT,
                    ownerId: FOUNDER_TENANT,
                    ownerEmail: founderData.ownerEmail,
                    name: founderData.name,
                    plan: founderData.plan || 'founder',
                    forcedFix: true
                };
                
                localStorage.setItem('tenant', JSON.stringify(correctTenantData));
                localStorage.setItem('tenantId', FOUNDER_TENANT);
                localStorage.setItem('currentTenantId', FOUNDER_TENANT);
                
                // Clear any wrong tenant data
                localStorage.removeItem('tenant_HihMMQuIh52phzB2yety');
                localStorage.removeItem('offline-tenant');
                
                // Set global window variable for immediate use
                window.currentTenantId = FOUNDER_TENANT;
                window.forcedTenant = correctTenantData;
                
                output += '<div class="success">‚úÖ Browser forced to use founder tenant</div>';
                output += '<div class="success">‚úÖ localStorage updated with correct tenant</div>';
                
                // Step 4: Verification
                output += '<h4>Step 4: Verification</h4>';
                const verifyApiRef = doc(db, 'MarketGenie_tenants', FOUNDER_TENANT, 'integrations', 'prospeo-io');
                const verifyApiSnap = await getDoc(verifyApiRef);
                
                if (verifyApiSnap.exists()) {
                    output += '<div class="success">‚úÖ API key verified in founder tenant</div>';
                } else {
                    output += '<div class="error">‚ùå API key verification failed</div>';
                }
                
                output += '<div class="warning">‚ö†Ô∏è IMPORTANT: Refresh your Market Genie app now!</div>';
                output += '<div class="info">üéØ Your app should now use tenant: ' + FOUNDER_TENANT + '</div>';
                output += '<div class="info">üîë Prospeo API key is ready for bulk scraper</div>';
                
                // Add refresh button
                output += '<div style="margin: 20px 0;"><button onclick="window.location.href=\'/\';" style="background: #28a745; padding: 15px 30px; font-size: 16px;">üîÑ Go to Market Genie App</button></div>';
                
                resultsDiv.innerHTML = output;
                document.getElementById('apiKeyInput').value = '';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Fix failed: ${error.message}</div>`;
                console.error('Fix error:', error);
            }
        };
    </script>
</body>
</html>